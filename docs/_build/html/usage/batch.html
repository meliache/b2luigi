

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Batch Processing &mdash; b2luigi 0.4.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Belle II specific examples" href="../advanced/basf2-examples.html" />
    <link rel="prev" title="Quick Start" href="quickstart.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> b2luigi
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Batch Processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#choosing-the-batch-system">Choosing the batch system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#choosing-the-environment">Choosing the Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#file-system">File System</a></li>
<li class="toctree-l2"><a class="reference internal" href="#drawbacks-of-the-batch-mode">Drawbacks of the batch mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#batch-system-specific-settings">Batch System Specific Settings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lsf">LSF</a></li>
<li class="toctree-l3"><a class="reference internal" href="#htcondor">HTCondor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gbasf2-wrapper-for-lcg-jobs">Gbasf2 Wrapper for LCG jobs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#add-your-own-batch-system">Add your own batch system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/basf2-examples.html">Belle II specific examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/run_modes.html">Run Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/development.html">Development and TODOs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">b2luigi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Batch Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usage/batch.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="batch-processing">
<span id="batch-label"></span><h1>Batch Processing<a class="headerlink" href="#batch-processing" title="Permalink to this headline">¶</a></h1>
<p>As shown in <a class="reference internal" href="quickstart.html#quick-start-label"><span class="std std-ref">Quick Start</span></a>, using the batch instead of local processing is really just a <code class="docutils literal notranslate"><span class="pre">--batch</span></code>
on the command line or calling <code class="docutils literal notranslate"><span class="pre">process</span></code> with <code class="docutils literal notranslate"><span class="pre">batch=True</span></code>.
However, there is more to discover!</p>
<div class="section" id="choosing-the-batch-system">
<h2>Choosing the batch system<a class="headerlink" href="#choosing-the-batch-system" title="Permalink to this headline">¶</a></h2>
<p>Using <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code>’s settings mechanism (described here <a class="reference internal" href="../documentation/api.html#b2luigi.get_setting" title="b2luigi.get_setting"><code class="xref py py-meth docutils literal notranslate"><span class="pre">b2luigi.get_setting()</span></code></a>) you can choose which
batch system should be used.
Currently, <code class="docutils literal notranslate"><span class="pre">htcondor</span></code> and <code class="docutils literal notranslate"><span class="pre">lsf</span></code> are supported.
There is also an experimental wrapper for <code class="docutils literal notranslate"><span class="pre">gbasf2</span></code>, the Belle II
submission tool for the LHC Worlwide Computing Grid, which works for <code class="docutils literal notranslate"><span class="pre">Basf2PathTask</span></code> tasks.
More will come soon (PR welcome!).</p>
</div>
<div class="section" id="choosing-the-environment">
<h2>Choosing the Environment<a class="headerlink" href="#choosing-the-environment" title="Permalink to this headline">¶</a></h2>
<p>If you are doing a local calculation, all calculated tasks will use the same environment (e.g. <code class="docutils literal notranslate"><span class="pre">$PATH</span></code> setting, libraries etc.)
as you have currently set up when calling your script(s).
This makes it predictable and simple.</p>
<p>Things get a bit more complicated when using a batch farm, as the workers might not have the same environment set up, the batch
submission does not copy the environment (or the local site administrators have forbidden that) or the system on the workers
is so different that copying the environment from the scheduling machine does not make sense.</p>
<p>Therefore <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code> provides you with three mechanism to set the environment for each task:</p>
<ul>
<li><p>You can give a bash script in the <code class="docutils literal notranslate"><span class="pre">env_script</span></code> setting (via <code class="docutils literal notranslate"><span class="pre">set_setting()</span></code>, <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> or for each task as usual,
see <a class="reference internal" href="../documentation/api.html#b2luigi.get_setting" title="b2luigi.get_setting"><code class="xref py py-meth docutils literal notranslate"><span class="pre">b2luigi.get_setting()</span></code></a>), which will be called even before anything else on the worker.
Use it to set up things like the path variables or the libraries (e.g. when you are using a virtual environment) and your
batch system does not support environment copy from the scheduler to the workers.
For example a useful script might look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source my virtual environment</span>
<span class="nb">source</span> venv/bin/activate
<span class="c1"># Set some specific settings</span>
<span class="nb">export</span> MY_IMPORTANT_SETTING <span class="m">10</span>
</pre></div>
</div>
</li>
<li><p>You can set the <code class="docutils literal notranslate"><span class="pre">env</span></code> setting to a dictionary, which contains additional variables to be set up before your job runs.
Using the mechanism described in <a class="reference internal" href="../documentation/api.html#b2luigi.get_setting" title="b2luigi.get_setting"><code class="xref py py-meth docutils literal notranslate"><span class="pre">b2luigi.get_setting()</span></code></a> it is possible to make this task- or even parameter-dependent.</p></li>
<li><p>By default, <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code> re-uses the same <code class="docutils literal notranslate"><span class="pre">python</span></code> executable on the workers as you used to schedule the tasks (by calling your script).
In some cases, this specific python executable is not present on the worker or is not usable (e.g. because of different operation systems
or architectures).
You can choose a new executable with the <code class="docutils literal notranslate"><span class="pre">executable</span></code> setting (it is also possible to just use <code class="docutils literal notranslate"><span class="pre">python3</span></code> as the executable assuming
it is in the path).
The executable needs to be callable after your <code class="docutils literal notranslate"><span class="pre">env_script</span></code> or your specific <code class="docutils literal notranslate"><span class="pre">env</span></code> settings are used.
Please note, that the <code class="docutils literal notranslate"><span class="pre">environment</span></code> setting is a list, so you need to pass your python executable with possible arguments like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b2luigi</span><span class="o">.</span><span class="n">set_setting</span><span class="p">(</span><span class="s2">&quot;executable&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">])</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="file-system">
<h2>File System<a class="headerlink" href="#file-system" title="Permalink to this headline">¶</a></h2>
<p>Depending on your batch system, the filesystem on the worker processing the task and the scheduler machine can be different or even unrelated.
Different batch systems and batch systems implementations treat this fact differently.
In the following, the basic procedure and assumption is explained.
Any deviation from this is described in the next section.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code> needs at least two folders to be accessible from the scheduling as well as worker machine:
the result folder and the folder of your script(s).
If possible, use absolute paths for the result and log directory to prevent any problems.
Some batch systems (e.g. htcondor) support file copy mechanisms from the scheduler to the worker systems.
Please checkout the specifics below.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>All relative paths given to e.g. the <code class="docutils literal notranslate"><span class="pre">result_dir</span></code> or the <code class="docutils literal notranslate"><span class="pre">log_dir</span></code> are always evaluated
relative to the folder where your script lives.
To prevent any disambiguities, try to use absolute paths whenever possible.</p>
</div>
<p>Some batch system starts the job in an arbitrary folder on the workers instead of the current folder on the scheduler.
That is why <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code> will change the directory into the path of your called script before starting the job.</p>
<p>In case your script is accessible from a different location on the worker than on the scheduling machine, you can give the setting <code class="docutils literal notranslate"><span class="pre">working_dir</span></code>
to specify where the job should run.
Your script needs to be in this folder and every relative path (e.g. for results or log) will be evaluated from there.</p>
</div>
<div class="section" id="drawbacks-of-the-batch-mode">
<h2>Drawbacks of the batch mode<a class="headerlink" href="#drawbacks-of-the-batch-mode" title="Permalink to this headline">¶</a></h2>
<p>Although the batch mode has many benefits, it would be unfair to not mention its downsides:</p>
<ul class="simple">
<li><p>You have to choose the queue/batch settings/etc. depending in your requirements (e.g. wall clock time) by yourself.
So you need to make sure that the tasks will actually finish before the batch system kills them because of timeout.
There is just no way for <code class="docutils literal notranslate"><span class="pre">b2luigi</span></code> to know this beforehand.</p></li>
<li><p>There is currently no resubmission implemented.
This means dying jobs because of batch system failures are just dead.
But because of the dependency checking mechanism of <code class="docutils literal notranslate"><span class="pre">luigi</span></code> it is simple to just redo the calculation
and re-calculate what is missing.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">luigi</span></code> feature to request new dependencies while task running (via <code class="docutils literal notranslate"><span class="pre">yield</span></code>) is not implemented for
the batch mode so far.</p></li>
</ul>
</div>
<div class="section" id="batch-system-specific-settings">
<h2>Batch System Specific Settings<a class="headerlink" href="#batch-system-specific-settings" title="Permalink to this headline">¶</a></h2>
<p>Every batch system has special settings.
You can look them up here:</p>
<div class="section" id="lsf">
<h3>LSF<a class="headerlink" href="#lsf" title="Permalink to this headline">¶</a></h3>
<dl class="py class">
<dt id="b2luigi.batch.processes.lsf.LSFProcess">
<em class="property">class </em><code class="sig-prename descclassname">b2luigi.batch.processes.lsf.</code><code class="sig-name descname">LSFProcess</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.lsf.LSFProcess" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#b2luigi.batch.processes.BatchProcess" title="b2luigi.batch.processes.BatchProcess"><code class="xref py py-class docutils literal notranslate"><span class="pre">b2luigi.batch.processes.BatchProcess</span></code></a></p>
<p>Reference implementation of the batch process for a LSF batch system.</p>
<p>Additional to the basic batch setup (see <a class="reference internal" href="#batch-label"><span class="std std-ref">Batch Processing</span></a>), additional
LSF-specific things are:</p>
<ul>
<li><p>the LSF queue can be controlled via the <code class="docutils literal notranslate"><span class="pre">queue</span></code> parameter, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyLongTask</span><span class="p">(</span><span class="n">b2luigi</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
</pre></div>
</div>
<p>The default is the short queue “s”.</p>
</li>
<li><p>By default, the environment variables from the scheduler are copied to
the workers.
This also applies we start in the same working directory and can reuse
the same executable etc.
Normally, you do not need to supply <code class="docutils literal notranslate"><span class="pre">env_script</span></code> or alike.</p></li>
</ul>
</dd></dl>

</div>
<div class="section" id="htcondor">
<h3>HTCondor<a class="headerlink" href="#htcondor" title="Permalink to this headline">¶</a></h3>
<dl class="py class">
<dt id="b2luigi.batch.processes.htcondor.HTCondorProcess">
<em class="property">class </em><code class="sig-prename descclassname">b2luigi.batch.processes.htcondor.</code><code class="sig-name descname">HTCondorProcess</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.htcondor.HTCondorProcess" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#b2luigi.batch.processes.BatchProcess" title="b2luigi.batch.processes.BatchProcess"><code class="xref py py-class docutils literal notranslate"><span class="pre">b2luigi.batch.processes.BatchProcess</span></code></a></p>
<p>Reference implementation of the batch process for a HTCondor batch system.</p>
<p>Additional to the basic batch setup (see <a class="reference internal" href="#batch-label"><span class="std std-ref">Batch Processing</span></a>), additional
HTCondor-specific things are:</p>
<ul>
<li><p>Please note that most of the HTCondor batch farms do not have the same
environment setup on submission and worker machines, so you probably want to give an
<code class="docutils literal notranslate"><span class="pre">env_script</span></code>, an <code class="docutils literal notranslate"><span class="pre">env</span></code> setting and/or a different <code class="docutils literal notranslate"><span class="pre">executable</span></code>.</p></li>
<li><p>HTCondor supports copying files from submission to workers. This means if the
folder of your script(s)/python project/etc. is not accessible on the worker, you can
copy it from the submission machine by adding it to the setting <code class="docutils literal notranslate"><span class="pre">transfer_files</span></code>.
This list can host both folders and files.
Please note that due to HTCondors file transfer mechanism, all specified folders
and files will be copied into the worker node flattened, so if you specify
<cite>a/b/c.txt</cite> you will end up with a file <cite>c.txt</cite>.
If you use the <code class="docutils literal notranslate"><span class="pre">transfer_files</span></code> mechanism, you need to set the <code class="docutils literal notranslate"><span class="pre">working_dir</span></code> setting to “.”
as the files will end up in the current worker scratch folder.
All specified files/folders should be absolute paths.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Please do not specify any parts or the full results folder. This will lead to unexpected
behavior. We are working on a solution to also copy results, but until this the
results folder is still expected to be shared.</p>
</div>
<p>If you copy your python project using this setting to thw worker machine, do not
forget to actually set it up in your setup script.
Additionally, you might want to copy your <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> as well.</p>
</li>
<li><p>You can give an <code class="docutils literal notranslate"><span class="pre">htcondor_setting</span></code> dict setting flag for additional options, such as
requested memory etc. It’s value has to be a dictionary containing HTCondor settings as key/value pairs.
These options will be written into the job submission file.
For an overview of possible settings refer to the
<a class="reference external" href="https://htcondor.readthedocs.io/en/latest/users-manual/submitting-a-job.html#">HTCondor documentation</a>.</p></li>
</ul>
<p class="rubric">Example</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">b2luigi</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">MyNumberTask</span><span class="p">(</span><span class="n">b2luigi</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">some_parameter</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">IntParameter</span><span class="p">()</span>

    <span class="n">htcondor_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;request_cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;request_memory&quot;</span><span class="p">:</span> <span class="s2">&quot;100 MB&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_output</span><span class="p">(</span><span class="s2">&quot;output_file.txt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am now starting a task&quot;</span><span class="p">)</span>
        <span class="n">random_number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_parameter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_file_name</span><span class="p">(</span><span class="s2">&quot;output_file.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">random_number</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyAverageTask</span><span class="p">(</span><span class="n">b2luigi</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">htcondor_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;request_cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;request_memory&quot;</span><span class="p">:</span> <span class="s2">&quot;200 MB&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">MyNumberTask</span><span class="p">,</span> <span class="n">some_parameter</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_to_output</span><span class="p">(</span><span class="s2">&quot;average.txt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am now starting the average task&quot;</span><span class="p">)</span>
        
        <span class="c1"># Build the mean</span>
        <span class="n">summed_numbers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_file_names</span><span class="p">(</span><span class="s2">&quot;output_file.txt&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">summed_numbers</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">average</span> <span class="o">=</span> <span class="n">summed_numbers</span> <span class="o">/</span> <span class="n">counter</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_output_file_name</span><span class="p">(</span><span class="s2">&quot;average.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">average</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">b2luigi</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">MyAverageTask</span><span class="p">(),</span> <span class="n">workers</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</dd></dl>

</div>
<div class="section" id="gbasf2-wrapper-for-lcg-jobs">
<h3>Gbasf2 Wrapper for LCG jobs<a class="headerlink" href="#gbasf2-wrapper-for-lcg-jobs" title="Permalink to this headline">¶</a></h3>
<dl class="py class">
<dt id="b2luigi.batch.processes.gbasf2.Gbasf2Process">
<em class="property">class </em><code class="sig-prename descclassname">b2luigi.batch.processes.gbasf2.</code><code class="sig-name descname">Gbasf2Process</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.gbasf2.Gbasf2Process" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#b2luigi.batch.processes.BatchProcess" title="b2luigi.batch.processes.BatchProcess"><code class="xref py py-class docutils literal notranslate"><span class="pre">b2luigi.batch.processes.BatchProcess</span></code></a></p>
<p>Batch process for working with gbasf2 projects on <em>LHC Computing Grid</em> (LCG).</p>
<p><strong>What it does</strong></p>
<dl class="simple">
<dt>gbasf2 project submission</dt><dd><p>The gbasf2 batch process takes the basf2 path returned by the <code class="docutils literal notranslate"><span class="pre">create_path()</span></code>
method of the task, saves it to the disk and creates a wrapper steering file that
executes the saved path. It then sends both to the LCG via
the BelleII-specific Dirac-wrapper gbasf2.</p>
</dd>
<dt>Project status monitoring</dt><dd><p>After the project submission, the gbasf batch process regularly checks the status
of all the jobs belonging to a gbasf2 project returns a success if
all jobs had been successful, while a single failed job results in a failed project.</p>
</dd>
<dt>Download of datasets and logs</dt><dd><p>If all jobs had been successful, it automatically downloads the output dataset and
the log files from the job sandboxes.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Limitations</strong></p>
<ul class="simple">
<li><p>The gbasf2 batch process for luigi can only be used for tasks
inhereting from <code class="docutils literal notranslate"><span class="pre">Basf2PathTask</span></code> or other tasks with a
<code class="docutils literal notranslate"><span class="pre">create_path()</span></code> method that returns a basf2 path.</p></li>
<li><p>It can only be used for pickable/serializable basf2 paths, as it stores
the path created by <code class="docutils literal notranslate"><span class="pre">create_path</span></code> in a python pickle file and runs that on the grid.</p></li>
<li><p>basf2 variable aliases are at the moment not supported, as they are not included in the pickled path</p></li>
</ul>
</div>
<p><strong>Usage</strong></p>
<dl>
<dt>Settings for gbasf2 tasks</dt><dd><blockquote>
<div><p>To submit a task with the gbasf2 wrapper, you first you have to add the property
<code class="docutils literal notranslate"><span class="pre">batch_system</span> <span class="pre">=</span> <span class="pre">&quot;gbasf2&quot;</span></code>, which sets the <code class="docutils literal notranslate"><span class="pre">batch_system</span></code> setting.
It is not recommended to set that setting globally, as not all tasks can be submitted to the grid,
but only tasks with a <code class="docutils literal notranslate"><span class="pre">create_path</span></code> method.</p>
<p>For gbasf2 tasks it is further required to set the settings</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gbasf2_input_dataset</span></code>: The input dataset on the grid to use.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gbasf2_project_name_prefix</span></code>: A string with which your gbasf2 project names will start.
To ensure the project associate with each unique task (i.e. for each of luigi parameters)
is unique, a hash generated from the luigi parameters of the task will be appended to the prefix
to create the actual gbasf2 project name.</p></li>
</ul>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">Basf2PathTask</span><span class="p">):</span>
    <span class="n">batch_system</span> <span class="o">=</span> <span class="s2">&quot;gbasf2&quot;</span>
    <span class="n">gbasf2_project_name_prefix</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">significant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gbasf2_input_dataset</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">hashed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The following settings are not required as they have default values, but those might not work for you:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gbasf2_install_directory</span></code>: If your gbasf2 install location is not <code class="docutils literal notranslate"><span class="pre">~/gbasf2KEK</span></code>, you have set this,
so that the gbasf2 batch process can set up the gbasf2 environment for its gbasf2 commands.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gbasf2_download_directory</span></code>: Defines in which directory the <code class="docutils literal notranslate"><span class="pre">gb2_ds_get</span></code> download will called
to download the result dataset.
The output will then be in the in a subdirectory of that directory with the name of the project.
It defaults to the current directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gbasf2_release</span></code>: Set this if you want the jobs to use another release on the grid than your
currently set up release, which is the default.</p></li>
</ul>
<p>By setting <code class="docutils literal notranslate"><span class="pre">gbasf2_print_status_updates</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code> you can turn off the printing of of the job summaries,
that is the number of jobs in different states in a gbasf2 project.</p>
<p>The following optional settings correspond to the equally named <code class="docutils literal notranslate"><span class="pre">gbasf</span></code> command line options
(without the <code class="docutils literal notranslate"><span class="pre">gbasf_</span></code> prefix) that you can set to customize your gbasf2 project:</p>
<p><code class="docutils literal notranslate"><span class="pre">gbasf2_additional_files</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_n_repition_job</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_force_submission</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_cputime</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_evtpersec</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_priority</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_jobtype</span></code>,
<code class="docutils literal notranslate"><span class="pre">gbasf2_basf2opt</span></code></p>
</div></blockquote>
<p>It is further possible to append arbitrary command line arguments to the <code class="docutils literal notranslate"><span class="pre">gbasf2</span></code> submission command
with the <code class="docutils literal notranslate"><span class="pre">gbasf2_additional_params</span></code> setting.
If you want to blacklist a grid site, you can e.g. add</p>
</dd>
<dt>Example</dt><dd><p>Here is an example file to submit an analysis path created by the script in
<code class="docutils literal notranslate"><span class="pre">examples/gbasf2/example_mdst_analysis</span></code> to grid via gbasf2:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">File: <code class="docutils literal notranslate"><span class="pre">examples/gbasf2/gbasf2_example.py</span></code></span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">b2luigi</span>
<span class="kn">from</span> <span class="nn">b2luigi.basf2_helper.tasks</span> <span class="kn">import</span> <span class="n">Basf2PathTask</span>
<span class="kn">from</span> <span class="nn">b2luigi.batch.processes.gbasf2</span> <span class="kn">import</span> <span class="n">get_unique_gbasf2_project_name</span>
<span class="kn">import</span> <span class="nn">example_mdst_analysis</span>


<span class="k">class</span> <span class="nc">MyAnalysisTask</span><span class="p">(</span><span class="n">Basf2PathTask</span><span class="p">):</span>
    <span class="c1"># set the batch_system property to use the gbasf2 wrapper batch process for this task</span>
    <span class="n">batch_system</span> <span class="o">=</span> <span class="s2">&quot;gbasf2&quot;</span>
    <span class="c1"># Must define a prefix for the gbasf2 project name to submit to the grid.</span>
    <span class="c1"># b2luigi will then add a hash derived from the luigi parameters to create a unique project name.</span>
    <span class="n">gbasf2_project_name_prefix</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">significant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gbasf2_input_dataset</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">hashed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># As an example we define a cut range as a b2luigi ListParameter, so that we</span>
    <span class="c1"># can automatically create multiple tasks and thus multiple independent</span>
    <span class="c1"># gbasf2 projects for differents sets of cuts</span>
    <span class="n">mbc_range</span> <span class="o">=</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">ListParameter</span><span class="p">(</span><span class="n">hashed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">example_mdst_analysis</span><span class="o">.</span><span class="n">create_analysis_path</span><span class="p">(</span><span class="n">mbc_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mbc_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the output to be the directory into which the ``gb2_ds_get``</span>
<span class="sd">        command, which is wrapped by the gbasf2 batch system, downloads the</span>
<span class="sd">        dataset.  It is defined by the contatenation of the</span>
<span class="sd">        ``gbasf2_download_dir`` and ``gbasf2_project_name`` settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gbasf2_project_name</span> <span class="o">=</span> <span class="n">get_unique_gbasf2_project_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">gbasf2_dataset_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gbasf2_download_dir</span><span class="p">,</span> <span class="n">gbasf2_project_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b2luigi</span><span class="o">.</span><span class="n">LocalTarget</span><span class="p">(</span><span class="n">gbasf2_dataset_dir</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MasterTask</span><span class="p">(</span><span class="n">b2luigi</span><span class="o">.</span><span class="n">WrapperTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We use the MasterTask to require multiple analyse tasks with different input</span>
<span class="sd">    datasets and cut values.  For each parameter combination, a different gbasf2</span>
<span class="sd">    project will be submitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gbasf2_input_datasets</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;/belle/MC/release-04-00-03/DB00000757/MC13a/prod00009434/s00/e1003/4S/r00000/mixed/mdst/sub00&quot;</span><span class="p">,</span>
            <span class="s2">&quot;/belle/MC/release-04-00-03/DB00000757/MC13a/prod00009435/s00/e1003/4S/r00000/charged/mdst/sub00&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># if you want to iterate over different cuts, just add more values to this list</span>
        <span class="n">mbc_lower_cuts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.15</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mbc_lower_cut</span> <span class="ow">in</span> <span class="n">mbc_lower_cuts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">input_ds</span> <span class="ow">in</span> <span class="n">gbasf2_input_datasets</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">MyAnalysisTask</span><span class="p">(</span>
                    <span class="n">mbc_range</span><span class="o">=</span><span class="p">(</span><span class="n">mbc_lower_cut</span><span class="p">,</span> <span class="mf">5.3</span><span class="p">),</span>
                    <span class="n">gbasf2_project_name_prefix</span><span class="o">=</span><span class="s2">&quot;luigiExampleMultiDS&quot;</span><span class="p">,</span>
                    <span class="n">gbasf2_input_dataset</span><span class="o">=</span><span class="n">input_ds</span><span class="p">,</span>
                    <span class="n">max_event</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">b2luigi</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">MasterTask</span><span class="p">(),</span> <span class="n">workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Some settings are done as task-specific class attributes, others are defined
in the <code class="docutils literal notranslate"><span class="pre">settings.json</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">File: <code class="docutils literal notranslate"><span class="pre">examples/gbasf2/settings.json</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;gbasf2_install_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;~/gbasf2KEK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gbasf2_print_status_updates&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;gbasf2_download_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gbasf2_cputime&quot;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</dd>
<dt>Handling failed jobs</dt><dd><p>The gbasf2 input wrapper considers the gbasf2 project as failed if any of
the jobs in the project failed.  It the automatically downloads the logs, so
please look into them to see what the reason was. You then need to resubmit them
manually with the <code class="docutils literal notranslate"><span class="pre">gb2_job_reschedule</span></code> or delete them with
<code class="docutils literal notranslate"><span class="pre">gb2_job_delete</span></code> so that the gbasf2 batch process doesn’t know they ever
existed. Then run just run your luigi task/script again.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Note on nomenclature:</strong>
The <code class="docutils literal notranslate"><span class="pre">BatchProcess</span></code> is intended to work with jobs, thus is has method names such as
<code class="docutils literal notranslate"><span class="pre">get_job_status</span></code>. The gbasf2 implementation of that class is special in that it wraps
gbasf2 projects, of which each contains multiple grid jobs, one for each file in the input
dataset. The actual (sub-) job handling is left to gbasf2. So the job status of the batch process
refers to the status of the whole project.</p>
</div>
<p><strong>Planned features</strong></p>
<ul class="simple">
<li><p>automatically reschedule failed jobs until a maximum number of retries is reached</p></li>
<li><p>add some helper functionality to deal with output, to avoid having to redefine
task output when switching between local batch process and gbasf2 batch process.</p></li>
</ul>
</dd></dl>

</div>
</div>
<div class="section" id="add-your-own-batch-system">
<h2>Add your own batch system<a class="headerlink" href="#add-your-own-batch-system" title="Permalink to this headline">¶</a></h2>
<p>If you want to add a new batch system, all you need to do is to implement the
abstract functions of <code class="docutils literal notranslate"><span class="pre">BatchProcess</span></code> for your system:</p>
<dl class="py class">
<dt id="b2luigi.batch.processes.BatchProcess">
<em class="property">class </em><code class="sig-prename descclassname">b2luigi.batch.processes.</code><code class="sig-name descname">BatchProcess</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">scheduler</span></em>, <em class="sig-param"><span class="n">result_queue</span></em>, <em class="sig-param"><span class="n">worker_timeout</span></em><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.BatchProcess" title="Permalink to this definition">¶</a></dt>
<dd><p>This is the base class for all batch algorithms that allow luigi to run on a specific batch system.
This is an abstract base class and inheriting classes need to supply functionalities for
* starting a job using the commands in self.task_cmd
* getting the job status of a running, finished or failed job
* and killing a job
All those commands are called from the main process, which is not running on the batch system.
Every batch system that is capable of these functions can in principle work together with b2luigi.</p>
<dl>
<dt>Implementation note:</dt><dd><p>In principle, using the batch system is transparent to the user. In case of problems, it
may however be useful to understand how it is working.</p>
<p>When you start your luigi dependency tree with <code class="docutils literal notranslate"><span class="pre">process(...,</span> <span class="pre">batch=True)</span></code>, the normal
luigi process is started looking for unfinished tasks and running them etc.
Normally, luigi creates a process for each running task and runs them either directly
or on a different core (if you have enabled more than one worker).
In the batch case, this process is not a normal python multiprocessing process,
but this BatchProcess, which has the same interface (one can check the status of the process,
start or kill it). The process does not need to wait for the batch job to finish but
is asked repeatedly for the job status. By this, most of the core functionality of luigi
is kept and reused.
This also means, that every batch job only includes a single task and is finished whenever
this task is done decreasing the batch runtime. You will need exactly as many batch jobs
as you have tasks and no batch job will idle waiting for input data as all are scheduled
only when the task they should run is actually runnable (the input files are there).</p>
<p>What is the batch command now? In each job, we call a specific executable bash script
only created for this task. It contains the setup of the environment (if given by the
user via the settings), the change of the working directory (the directory of the
python script or a specified directory by the user) and a call of this script with the
current python interpreter (the one you used to call this main file or given by the
setting <code class="docutils literal notranslate"><span class="pre">executable</span></code>) . However, we give this call an additional parameter, which tells it
to only run one single task. Task can be identified by their task id. A typical task command may look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">your</span><span class="o">-</span><span class="n">exec</span><span class="o">&gt;/</span><span class="n">python</span> <span class="o">/</span><span class="n">your</span><span class="o">-</span><span class="n">project</span><span class="o">/</span><span class="n">some</span><span class="o">-</span><span class="n">file</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">batch</span><span class="o">-</span><span class="n">runner</span> <span class="o">--</span><span class="n">task</span><span class="o">-</span><span class="nb">id</span> <span class="n">MyTask_38dsf879w3</span>
</pre></div>
</div>
<p>if the batch job should run the MyTask. The implementation of the
abstract functions is responsible for creating an running the executable file and writing the log of
the job into appropriate locations. You can use the functions <code class="docutils literal notranslate"><span class="pre">create_executable_wrapper</span></code>
and <code class="docutils literal notranslate"><span class="pre">get_log_file_dir</span></code> to get the needed information.</p>
<p>Checkout the implementation of the lsf task for some implementation example.</p>
</dd>
</dl>
<dl class="py method">
<dt id="b2luigi.batch.processes.BatchProcess.get_job_status">
<code class="sig-name descname">get_job_status</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.BatchProcess.get_job_status" title="Permalink to this definition">¶</a></dt>
<dd><p>Implement this function to return the current job status.
How you identify exactly your job is dependent on the implementation and needs to
be handled by your own child class.</p>
<p>Must return one item of the JobStatus enumeration: running, aborted, successful or idle.
Will only be called after the job is started but may also be called when
the job is finished already.
If the task status is unknown, return aborted. If the task has not started already but
is scheduled, return running nevertheless (for b2luigi it makes no difference).
No matter if aborted via a call to kill_job, by the batch system or by an exception in the
job itself, you should return aborted if the job is not finished successfully
(maybe you need to check the exit code of your job).</p>
</dd></dl>

<dl class="py method">
<dt id="b2luigi.batch.processes.BatchProcess.kill_job">
<code class="sig-name descname">kill_job</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.BatchProcess.kill_job" title="Permalink to this definition">¶</a></dt>
<dd><p>This command is used to abort a job started by the start_job function.
It is only called once to abort a job, so make sure to either block until the job is really
gone or be sure that it will go down soon. Especially, do not wait until the job is finished.
It is called for example when the user presses Ctrl-C.</p>
<p>In some strange corner cases it may happen that this function is called even before the
job is started (the start_job function is called). In this case, you do not need to do anything
(but also not raise an exception).</p>
</dd></dl>

<dl class="py method">
<dt id="b2luigi.batch.processes.BatchProcess.start_job">
<code class="sig-name descname">start_job</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#b2luigi.batch.processes.BatchProcess.start_job" title="Permalink to this definition">¶</a></dt>
<dd><p>Override this function in your child class to start a job on the batch system.
It is called exactly once. You need to store any information identifying
your batch job on your own.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">b2luigi.core.utils.get_log_file_dir</span></code> and the
<code class="docutils literal notranslate"><span class="pre">b2luigi.core.executable.create_executable_wrapper</span></code> functions to get the log base name
and to create the executable script which you should call in your batch job.</p>
<p>After the start_job function is called by the framework (and no exception is thrown),
it is assumed that a batch job is started or scheduled.</p>
<p>After the job is finished (no matter if aborted or successful) we assume the stdout and stderr
is written into the two files given by b2luigi.core.utils.get_log_file_dir(self.task).</p>
</dd></dl>

</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../advanced/basf2-examples.html" class="btn btn-neutral float-right" title="Belle II specific examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="quickstart.html" class="btn btn-neutral float-left" title="Quick Start" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Nils Braun

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>